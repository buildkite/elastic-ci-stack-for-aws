#!/bin/bash

set -eu -o pipefail

if [[ "${ENABLE_PRE_EXIT_DISK_CLEANUP:-false}" == "true" ]]; then
  echo "Checking disk space"
  if ! /usr/local/bin/bk-check-disk-space.sh; then
    echo "~~~ :broom: Pruning docker resources"
    docker image prune --all --force --filter "until=${DOCKER_PRUNE_UNTIL:-4h}" || true

    if [[ "${DOCKER_BUILDER_PRUNE_ENABLED:-false}" == "true" ]]; then
      docker builder prune --all --force --filter "until=${DOCKER_PRUNE_UNTIL:-4h}" || true
    fi

    echo "Checking disk space again"
    # Capture disk space output for potential error logging
    if ! disk_check_output=$(/usr/local/bin/bk-check-disk-space.sh 2>&1); then
      echo "--- :warning: Disk health checks failed."
      echo "${disk_check_output}"

      # Check if instance termination is enabled (default: false for backward compatibility)
      if [[ "${BUILDKITE_TERMINATE_INSTANCE_ON_DISK_FULL:-false}" == "true" ]]; then
        echo "Terminating instance due to disk space issues."
        export BUILDKITE_TERMINATE_INSTANCE_AFTER_JOB=true

        if [[ -x /usr/local/bin/terminate-instance ]]; then
          /usr/local/bin/terminate-instance
        else
          echo "terminate-instance script not found, falling back to exit 1" >&2
          exit 1
        fi

        # Should not reach here if termination succeeds
        exit 1
      else
        echo "Exiting job due to insufficient disk space (set BuildkiteTerminateInstanceOnDiskFull to true in CloudFormation Stack to terminate instance instead)."
        exit 1
      fi
    fi
  fi
fi

# clean up our temporary docker config
if [[ -n "${BUILDKITE_DOCKER_CONFIG_TEMP_DIRECTORY:-}" && -d "$BUILDKITE_DOCKER_CONFIG_TEMP_DIRECTORY" ]]; then
  rm -rf "$BUILDKITE_DOCKER_CONFIG_TEMP_DIRECTORY"
fi

if [[ -n "${BUILDKITE_SECRETS_BUCKET:-}" && "${SECRETS_PLUGIN_ENABLED:-}" == "1" ]]; then
  export BUILDKITE_PLUGIN_S3_SECRETS_BUCKET="$BUILDKITE_SECRETS_BUCKET"

  # shellcheck source=/dev/null
  source /usr/local/buildkite-aws-stack/plugins/secrets/hooks/pre-exit
fi
